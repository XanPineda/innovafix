{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="container py-5">

    <h1 class="mb-4">Gesti√≥n de Ingresos</h1>

    <!-- Bot√≥n para abrir el modal -->
    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalIngreso">
        Agregar Ingreso
    </button>

    <!-- Modal para crear ingreso -->
    <div class="modal fade" id="modalIngreso" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Agregar Ingreso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form method="post" id="form-crear-ingreso" action="{% url 'ingreso_crear' %}">
                        {% csrf_token %}

                        <!-- Campos principales del ingreso -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre Usuario</label>
                                {{ form.usuCedula }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Proveedor</label>
                                {{ form.proveedorNit }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Valor</label>
                                {{ form.ingresoValor }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cantidad</label>
                                {{ form.ingresoCantidad }}
                            </div>
                        </div>

                        <hr>

                        <!-- ==============================
                             Productos asociados (formset)
                        ============================== -->
                        <h5 class="mb-3">Productos asociados</h5>
                        {{ formset.management_form }}

                        <div id="form-container">
                            {% for f in formset %}
                                <div class="form-row border p-2 mb-2 rounded">
                                    {{ f.as_p }}
                                    <button type="button" class="btn btn-danger btn-sm remove-form">Eliminar</button>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- üëá Formulario vac√≠o para clonar -->
                        <div id="empty-form" style="display:none;">
                            <div class="form-row border p-2 mb-2 rounded">
                                {{ formset.empty_form.as_p }}
                                <button type="button" class="btn btn-danger btn-sm remove-form">Eliminar</button>
                            </div>
                        </div>

                        <button type="button" id="add-form" class="btn btn-secondary mb-3">
                            <i class="bi bi-plus"></i> Agregar Producto
                        </button>

                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-save"></i> Guardar Ingreso
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Lista de ingresos -->
    <h2>Ingresos Registrados</h2>
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Proveedor</th>
                    <th>Valor</th>
                    <th>Cantidad</th>
                    <th>Productos Asociados</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for ingreso in ingresos %}
                <tr>
                    <td>{{ ingreso.ingresoId }}</td>
                    <td>{{ ingreso.usuCedula.usuNombre }} {{ ingreso.usuCedula.usuApellido }}</td>
                    <td>{{ ingreso.proveedorNit.nombre }}</td>
                    <td>${{ ingreso.ingresoValor|floatformat:2|intcomma }}</td>
                    <td>{{ ingreso.ingresoCantidad }}</td>
                    <td>
                        <ul>
                        {% for producto in ingreso.producto_set.all %}
                            <li>{{ producto.productoNombre }} ({{ producto.productoCantidad }})</li>
                        {% empty %}
                            <li>No hay productos asociados</li>
                        {% endfor %}
                        </ul>
                    </td>
                    <td>
                        <a href="{% url 'ingreso_editar' ingreso.ingresoId %}" class="btn btn-primary me-1">Editar</a>
                        <form method="post" action="{% url 'ingreso_eliminar' ingreso.ingresoId %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No hay ingresos registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Script para formset din√°mico -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const addButton = document.querySelector("#add-form");
    const formContainer = document.querySelector("#form-container");
    const totalForms = document.querySelector("#id_producto_set-TOTAL_FORMS");
    const emptyForm = document.querySelector("#empty-form").innerHTML;

    let formNum = formContainer.children.length;

    if (addButton) {
        addButton.addEventListener("click", function () {
            let newFormHtml = emptyForm.replace(/_prefix_/g, formNum);
            formContainer.insertAdjacentHTML("beforeend", newFormHtml);
            formNum++;
            totalForms.value = formNum;
        });
    }

    // Eliminar fila de producto
    formContainer.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-form")) {
            e.target.closest(".form-row").remove();
            formNum--;
            totalForms.value = formNum;
        }
    });
});
</script>
{%endblock%}