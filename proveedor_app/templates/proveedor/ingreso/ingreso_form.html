{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Registrar Ingreso</h2>

    <form method="post" action="{% url 'ingreso_crear' %}">
        {% csrf_token %}

        <!-- Campos del ingreso -->
        <div class="card mb-4">
            <div class="card-header">
                Datos del Ingreso
            </div>
            <div class="card-body">
                {{ form.as_p }}
            </div>
        </div>

        <!-- Campos ocultos del formset -->
        {{ formset.management_form }}

        <!-- Productos -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                Productos
                <button id="add-form" class="btn btn-sm btn-success">+ Agregar producto</button>
            </div>
            <div class="card-body" id="productos-formset">
                {% for f in formset %}
                    <div class="formset-form border rounded p-3 mb-3">
                        {{ f.as_p }}
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Botón Guardar -->
        <button type="submit" class="btn btn-primary">Guardar</button>
        <a href="{% url 'ingreso_listar' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- Script para clonar formularios del formset -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    let formsetContainer = document.getElementById("productos-formset");
    let addButton = document.getElementById("add-form");
    let totalForms = document.getElementById("id_producto_set-TOTAL_FORMS");

    addButton.addEventListener("click", function (e) {
        e.preventDefault();

        let currentForms = parseInt(totalForms.value);
        let newForm = formsetContainer.querySelector(".formset-form").cloneNode(true);

        // Limpiar valores de los inputs del nuevo producto
        newForm.querySelectorAll("input, textarea").forEach(input => {
            input.value = "";
        });

        // Reemplazar los índices (producto_set-0-, producto_set-1-, etc.)
        newForm.innerHTML = newForm.innerHTML.replace(/producto_set-(\d+)-/g, "producto_set-" + currentForms + "-");

        formsetContainer.appendChild(newForm);

        //  Actualizar TOTAL_FORMS
        totalForms.value = currentForms + 1;
    });
});
</script>
{%endblock%}
