{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
<h2>Ventas</h2>

<!-- Buscador y botón -->
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
    <div class="search-wrapper flex-grow-1 d-flex">
        <input type="text" id="busquedaVenta" class="form-control search-input" placeholder="Buscar venta...">
        <button id="btnFiltrarVenta" class="btn btn-outline-secondary ms-2" type="button">
            <i class="fas fa-search"></i>
        </button>
    </div>
    <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ventaModal">
            <i class="fas fa-shopping-cart me-2"></i> Agregar Venta
        </button>
    </div>
</div>

<!-- Tabla de ventas -->
<table class="table table-bordered">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for venta in ventas %}
        <tr>
            <td>{{ venta.ventaId }}</td>
            <td>{{ venta.cliente }}</td>
            <td>{{ venta.fecha }}</td>
            <td>${{ venta.total }}</td>
            <td>
                <form method="post" action="{% url 'venta_eliminar' venta.ventaId %}" class="form-eliminar" style="display:inline;">
                    {% csrf_token %}
                    <button type="button" class="btn btn-trash btn-confirmar-eliminacion">
                        <i class="fas fa-trash-alt me-2"></i> Eliminar
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<!-- Modal para registrar venta -->
<div class="modal fade" id="ventaModal" tabindex="-1" aria-labelledby="ventaModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
    <div class="modal-content">
        <form method="post" id="ventaForm" action="{% url 'venta_crear' %}">
            {% csrf_token %}
            <div class="modal-header">
                <h5 class="modal-title" id="ventaModalLabel">Registrar Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    {{ form.cliente.label_tag }}
                    {{ form.cliente }}
                </div>

                {{ formset.management_form }}
                <table class="table table-bordered" id="productos-table">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for f in formset %}
                        <tr class="form-row">
                            <td>{{ f.producto }}</td>
                            <td>{{ f.cantidad }}</td>
                            <td>{{ f.precio_unitario }}</td>
                            <td>{{ f.subtotal }}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-row">-</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>


                <div class="mb-3">
                    <strong>Total: $<span id="total-venta">0.00</span></strong>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" class="btn btn-primary">Guardar Venta</button>
            </div>
        </form>
    </div>
</div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Confirmación de eliminación
    document.querySelectorAll('.btn-confirmar-eliminacion').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const form = btn.closest('form');
            Swal.fire({
                title: "¿Estás seguro?",
                text: "Esta acción no se puede deshacer.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, eliminar"
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });

    // Actualización de filas y total
    function updateRow(row) {
        const productoSelect = row.querySelector('select');
        const cantidadInput = row.querySelector('input[name$="cantidad"]');
        const precioInput = row.querySelector('input[name$="precio_unitario"]');
        const subtotalInput = row.querySelector('input[name$="subtotal"]');
        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
        const precio = selectedOption ? parseFloat(selectedOption.text.match(/\$(\d+(\.\d+)?)/)[1]) : 0;
        const cantidad = parseInt(cantidadInput.value) || 0;

        if (precioInput) precioInput.value = precio.toFixed(2);
        if (subtotalInput) subtotalInput.value = (precio * cantidad).toFixed(2);
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('input[name$="subtotal"]').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('total-venta').textContent = total.toFixed(2);
    }

    document.querySelectorAll('.form-row').forEach(row => {
        row.querySelector('select').addEventListener('change', () => updateRow(row));
        row.querySelector('input[name$="cantidad"]').addEventListener('input', () => updateRow(row));
        row.querySelector('.remove-row').addEventListener('click', () => {
            row.remove();
            updateTotal();
        });
        updateRow(row);
    });

    const addRowBtn = document.getElementById('add-row');
    addRowBtn.addEventListener('click', () => {
        const tableBody = document.querySelector('#productos-table tbody');
        const totalForms = document.querySelector('#id_productoventa_set-TOTAL_FORMS');
        const newIndex = parseInt(totalForms.value);
        const newRow = tableBody.querySelector('.form-row').cloneNode(true);

        newRow.querySelectorAll('input, select').forEach(el => {
            if (el.name) {
                el.name = el.name.replace(/-\\d+-/, `-${newIndex}-`);
                el.id = el.id.replace(/-\\d+-/, `-${newIndex}-`);
                if (el.type !== 'hidden') el.value = '';
            }
        });

        tableBody.appendChild(newRow);
        totalForms.value = newIndex + 1;

        newRow.querySelector('select').addEventListener('change', () => updateRow(newRow));
        newRow.querySelector('input[name$="cantidad"]').addEventListener('input', () => updateRow(newRow));
        newRow.querySelector('.remove-row').addEventListener('click', () => {
            newRow.remove();
            updateTotal();
        });

        updateRow(newRow);
    });
});
</script>

<!-- Mensajes de éxito -->
{% if messages %}
  {% for message in messages %}
    {% if 'agregado' in message.tags %}
      <script>
        Swal.fire({
          title: "¡Venta registrada!",
          text: "{{ message }}",
          icon: "success",
          showConfirmButton: false,
          timer: 2500
        });
      </script>
    {% elif 'eliminado' in message.tags %}
      <script>
        Swal.fire({
          title: "¡Venta eliminada!",
          text: "{{ message }}",
          icon: "success",
          showConfirmButton: false,
          timer: 2500
        });
      </script>
    {% endif %}
  {% endfor %}
{% endif %}

<style>
.modal-dialog {
    max-width: 800px;
    margin: 1.75rem auto;
}
.modal-content {
    border-radius: 8px;
    position: relative;
    z-index: 1200 !important;
}
.modal-body {
    max-height: 70vh;
    overflow-y: auto;
}
</style>
{% endblock %}